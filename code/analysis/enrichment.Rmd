---
title: "Enrichment"
output:
  html_document:
    pairs.df_print: paged
---


```{r eurofiles, cache=TRUE}
library(tidyr)
library(dplyr)
library(data.table)
library(ggplot2)

source('./enrichment.R')

rootdir <- '/scratch/groups/abattle4/victor/WatershedAFR/'
datadir <- paste0(rootdir,'/','data/')

```
##European Samples

```{r europrep, cache=TRUE, eval=FALSE}
# files needed for european variants
euro_z_scores = '/scratch/groups/abattle4/victor/WatershedAFR/data/outlier_calling/gtexV8.outlier.controls.v8ciseQTLs.globalOutliers.removed.medz.txt'
 # table of gene-individual pairs with their rare variants
euro_rare_var_pairs =
  # '/scratch/groups/abattle4/victor/WatershedAFR/data/rare_variants/old/gene-EUR-rv.txt' # table of gene-individual pairs with their rare variants
'/scratch/groups/abattle4/victor/WatershedAFR/data/rare_variants/gene-EUR-rv.txt'

euro_pop_list = '/scratch/groups/abattle4/victor/WatershedAFR/data/data_prep/gtex_v8_wgs_individuals_EUR.txt'  #list of samples from the desired population

```


Here are the results of enrichment on the European samples using thresholds 1, 1.2, 1.4, 1.6, 1.8, 2, 2.5, 3, 3.5, 4, 4.5, 5:
```{r euroretrieve, cache=TRUE}

euro.output.3 <- readRDS(paste0(datadir,'/european_1to5.rds'))
euro.output.3
```


###Binning Thresholds

#### Nothing above threshold + 0.5
```{r eurobin, cache=TRUE}

euro.output4 <- readRDS(paste0(datadir,'/european_1to5_binw05.rds'))
euro.output4

```

#### Cutoff at threshold + 1
```{r eurobin1, cache=TRUE}
thresholds <- sort(unique(c(seq(1,2,.2), seq(1,5,.5))))

euro.output5 <- enrichmentTipTail(
  pop_subset_file = euro_pop_list,
  z_scores_file = euro_z_scores, 
  rare_var_pairs_file = euro_rare_var_pairs ,
  output_dir = datadir, title.mod.pop = "European",
  thresholds = thresholds, outlier_bin_width = 1)

euro.output5
```



## African American Samples
```{r afroprep}
# files needed for african variants
afr_z_scores_file = '/scratch/groups/abattle4/victor/WatershedAFR/data/outlier_calling/gtexV8.outlier.controls.v8ciseQTLs.globalOutliers.removed.medz.txt'
afr_rare_var_pairs_file = '/scratch/groups/abattle4/victor/WatershedAFR/data/rare_variants/gene-AFR-rv.txt' # table of gene-individual pairs with their rare variants
afr_pop_list_file = '/scratch/groups/abattle4/victor/WatershedAFR/data/data_prep/gtex_v8_wgs_individuals_AFR.txt'
```

Here are the results of enrichment on the African samples using thresholds 1, 1.2, 1.4, 1.6, 1.8, 2, 2.5, 3, 3.5, 4, 4.5, 5:

```{r afrretrieve, cache=TRUE}

afr.output.3 <- readRDS(paste0(datadir,'/african_1to5.rds'))
afr.output.3

```


###Binning Thresholds
#### Cutoff at threshold + 0.5
```{r afrbin05_retrieve, cache=TRUE}
afr.output.4 <- readRDS(paste0(datadir,'/african_1to5_binw05.rds'))
afr.output.4

```

#### Cutoff at threshold + 1
```{r afrbin05_retrieve, cache=TRUE}
afr.output.5 <- readRDS(paste0(datadir,'/african_1to5_binw1.rds'))
afr.output.5

```


#### Cutoff at threshold + 0.25
```{r afrbin025_retrieve, cache=TRUE}
afr.output.6 <- readRDS(paste0(datadir,'/african_1to5_binw025.rds'))
afr.output.6

```

## Watershed 
```{r wtrshdprep}
wtrshd_z_scores_file = '/scratch/groups/abattle4/victor/WatershedAFR/data/outlier_calling/gtexV8.outlier.controls.v8ciseQTLs.globalOutliers.removed.medz.txt'
wtrshd_rare_var_pairs_file = '/work-zfs/abattle4/bstrober/rare_variant/gtex_v8/splicing/input_data/variant_calls/all_rare_variants_SNPs_10kb_genebody.txt' # table of gene-individual pairs with their rare variants
wtrshd_pop_list_file = '/scratch/groups/abattle4/victor/WatershedAFR/data/data_prep/gtex_v8_wgs_individuals_EUR.txt'

```


```{r wtrshdenrich, cache=TRUE}
wtrshd_output_prefix <- 'gtex_v8_wgs_individuals_wtshd'

rare.colnames <- c("Ind", "Gene", "Chrom", "Start", "End")

wtrshd.output <- enrichmentTipTail(pop_subset_file = wtrshd_pop_list_file, z_scores_file = wtrshd_z_scores_file, rare_var_pairs_file = wtrshd_rare_var_pairs_file, output_dir = datadir, title.mod.pop = "Watershed European", output_prefix = wtrshd_output_prefix, col.names = rare.colnames)


wtrshd.output


```

Results of enrichment on watershed output using thresholds 1, 1.2, 1.4, 1.6, 1.8, 2, 2.5, 3, 3.5, 4, 4.5, 5:
```{r wtrshdretrieve, cache=TRUE}

wtrshd.output.3 <- readRDS(paste0(datadir,'/wtrshdeuro_1to5.rds'))
wtrshd.output.3

```

```{r notes}
# pdf(paste0('/scratch/groups/abattle4/victor/WatershedAFR/data/figures','/enrichment_eur.pdf'))
```
